#! /system/bin/sh

# Copyright (c) 2025 ravindu644
# KernelSU Module Installer Script

# Core functions
export TMPDIR=/dev/tmp
export SCRIPT_DIR="$(readlink -f "$(dirname "$0")")"
mkdir -p "${TMPDIR}"

# logging functions
log() { echo "[+] $1"; }
error() { echo "[-] error: $1" && exit 1; }

# debug
[ -z "$ZIPFILE" ] && error "ZIPFILE is not set"
[ -z "$MODPATH" ] && error "MODPATH is not set"
[ -z "$TMPDIR" ] && error "TMPDIR is not set"

# Detect root method
detect_root() {
    echo ""
    if command -v magisk >/dev/null 2>&1; then
        ROOT_METHOD="magisk"
        echo -e "- Magisk detected\n"
        echo "- WARNING: You may face various terminal bugs with Magisk."
        echo -e "- You can try downgrading your Magisk version to v28 or v29.\n"
    elif command -v ksud >/dev/null 2>&1; then
        ROOT_METHOD="kernelsu"
        echo -e "- KernelSU detected\n"
    elif command -v apd >/dev/null 2>&1; then
        ROOT_METHOD="apatch"
        echo -e "- Apatch detected\n"
    else
        ROOT_METHOD="unknown"
        echo -e "- Unknown root method detected. Proceed with caution.\n"
    fi

    # Check for SuSFS compatibility
    if zcat /proc/config.gz 2>/dev/null | grep -q "CONFIG_KSU_SUSFS=y" || [ -d /data/adb/modules/susfs4ksu ]; then
        echo -e "WARNING: SuSFS detected. You may encounter mounting issues with \"/proc\".\n"
        echo -e "Fix: Disable \"HIDE SUS MOUNTS FOR ALL PROCESSES\" in SuSFS4KSU settings.\n"
    fi
}

# immediately extract the core files if exists
for file in common/system.prop module.prop common/service.sh common/post-fs-data.sh; do
    unzip -p "$ZIPFILE" "$file" &>/dev/null && unzip -oj "$ZIPFILE" "$file" -d "$MODPATH" || error "Failed to extract $file"
done

# crucial check to see if module.prop exists
[ ! -f "$MODPATH/module.prop" ] && error "module.prop not found.Cannot continue..!"

# fetch info from the module.prop
load_module_prop(){
    while IFS='=' read -r key value; do
        [ -z "$key" ] && continue
        [ "${key#\#}" != "$key" ] && continue
        value=$(echo "$value" | tr -d '><$')
        export "$key=$value"
    done < "$MODPATH/module.prop"
} && load_module_prop

# print some info about the module
print_module_info(){
  echo -e "\n-  By: $author"
  echo -e "-  Version: $version"
  echo -e "-  Architecture: $ARCH\n"
}

set_permissions(){
    set_nh_permissions
}
